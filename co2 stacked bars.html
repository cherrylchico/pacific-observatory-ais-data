<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monthly CO2 Emissions by Vessel Type</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 10px;
      padding: 10px;
      font-family: 'Open Sans', sans-serif;
      background-color: white;
    }
    h2 {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: bold;
    }
    p {
      font-size: 16px;
      color: #666;
      margin: 4px 0 15px;
    }
    #chartsContainer {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 20px;
      width: 100%;
      height: calc(100vh - 140px);
    }
    .chart {
      width: 100%;
      height: 100%;
      position: relative;
    }
    #slider {
      width: 100%;
      margin: 20px 0;
    }
    #footer {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Open Sans', sans-serif;
      font-size: 12px;
      color: #888;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<div id="titleRow">
  <h2>CO2 Emissions by Vessel Type</h2>
  <p>CO2 Equivalent (tonnes, % of total), Monthly</p>
</div>

<div id="legend" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; font-size: 12px; font-family: 'Open Sans', sans-serif;"></div>

<div id="chartsContainer"></div>

<div id="sliderContainer" style="width: 95%; margin: 20px auto; padding: 0 20px;">
  <div id="timeSlider"></div>
</div>

<div id="footer">
  <div>
    Source: <a href="https://www.worldbank.org" target="_blank" style="text-decoration: underline; color: #888;">World Bank Group</a>
  </div>
  <img src="https://public.flourish.studio/uploads/71a85b0c-7f8c-453b-bc80-22b945333d58.png" style="height: 25px; object-fit: contain; margin-right: 5px;" alt="Logo">
</div>

<script>
  const vesselTypes = ["Cargo", "Fishing", "Others", "Passenger", "Tanker"];
  const colors = {
    "Cargo": "#8DBCE8",
    "Fishing": "#F5A875",
    "Others": "#9D6BBF",
    "Passenger": "#95C975",
    "Tanker": "#DB8499"
  };
  
  let fullData = [];
  let allCountries = [];
  let timePoints = [];

  Papa.parse("https://raw.githubusercontent.com/cherrylchico/pacific-observatory-ais-data/main/data/Monthly%20CO2%20by%20Country%20Vessel%20Type.csv", {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      fullData = results.data.filter(d =>
        d.year && d.month && d.Country && d["Vessel Type"] && d.CO2eq
      );
      
      // Get unique countries and time points
      allCountries = [...new Set(fullData.map(d => d.Country))].sort();
      
      const uniqueTimes = [...new Set(fullData.map(d => `${d.year}-${String(d.month).padStart(2, '0')}`))].sort();
      timePoints = uniqueTimes;
      
      // Initialize charts
      initCharts();
      updateAllCharts();
    }
  });

  function initCharts() {
    const container = document.getElementById('chartsContainer');
    container.innerHTML = '';
    
    // First chart for all countries
    const allDiv = document.createElement('div');
    allDiv.id = 'chart-all';
    allDiv.className = 'chart';
    container.appendChild(allDiv);
    
    // Charts for individual countries (top 15)
    const topCountries = allCountries.slice(0, 15);
    topCountries.forEach(country => {
      const div = document.createElement('div');
      div.id = `chart-${country.replace(/\s+/g, '-')}`;
      div.className = 'chart';
      container.appendChild(div);
    });
  }

  function updateAllCharts() {
    // Create legend
    createLegend();
    
    // Update "All Countries" chart
    updateChart('chart-all', 'All Countries', fullData);
    
    // Update individual country charts
    const topCountries = allCountries.slice(0, 15);
    topCountries.forEach(country => {
      const countryData = fullData.filter(d => d.Country === country);
      updateChart(`chart-${country.replace(/\s+/g, '-')}`, country, countryData);
    });
    
    // Create shared slider
    createSharedSlider();
  }

  function createLegend() {
    const legendDiv = document.getElementById('legend');
    legendDiv.innerHTML = '';
    
    vesselTypes.forEach(vt => {
      const item = document.createElement('div');
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.gap = '5px';
      
      const colorBox = document.createElement('div');
      colorBox.style.width = '15px';
      colorBox.style.height = '15px';
      colorBox.style.backgroundColor = colors[vt];
      
      const label = document.createElement('span');
      label.textContent = vt;
      
      item.appendChild(colorBox);
      item.appendChild(label);
      legendDiv.appendChild(item);
    });
  }

  function updateChart(divId, title, data) {
    // Create traces for 100% stacked bar chart
    const traces = vesselTypes.map(vt => {
      const percentages = [];
      const xLabels = [];
      const absoluteValues = [];
      
      timePoints.forEach(tp => {
        const [year, month] = tp.split('-');
        
        // Get data for this time point
        const timeData = data.filter(d => 
          d.year == year && String(d.month).padStart(2, '0') == month
        );
        
        // Calculate totals by vessel type
        const totals = {};
        vesselTypes.forEach(v => {
          totals[v] = timeData
            .filter(d => d["Vessel Type"] === v)
            .reduce((sum, d) => sum + parseFloat(d.CO2eq || 0), 0);
        });
        
        const grandTotal = Object.values(totals).reduce((a, b) => a + b, 0);
        const percentage = grandTotal > 0 ? (totals[vt] / grandTotal) * 100 : 0;
        
        percentages.push(percentage);
        xLabels.push(tp);
        absoluteValues.push(totals[vt]);
      });
      
      return {
        x: xLabels,
        y: percentages,
        name: vt,
        type: 'bar',
        marker: {
          color: colors[vt]
        },
        hovertemplate: `%{x}<br>${vt}: %{y:.1f}%<br>CO2: %{customdata:,.0f} tonnes<extra></extra>`,
        customdata: absoluteValues,
        showlegend: false
      };
    });
    
    const layout = {
      title: {
        text: title,
        font: {
          size: 12,
          family: 'Open Sans, sans-serif'
        }
      },
      barmode: 'stack',
      xaxis: {
        showticklabels: true,
        showgrid: false,
        showline: true,
        linecolor: '#ccc',
        ticks: 'outside',
        tickcolor: '#ccc'
      },
      yaxis: {
        range: [0, 100],
        showticklabels: true,
        showgrid: true,
        griddash: 'dot',
        gridcolor: '#ccc',
        showline: true,
        linecolor: '#ccc',
        ticks: 'outside',
        tickcolor: '#ccc',
        ticksuffix: '%'
      },
      margin: {
        l: 40,
        r: 10,
        t: 30,
        b: 0
      },
      showlegend: divId === 'chart-all',
      legend: {
        orientation: 'h',
        x: 0,
        y: -0.15,
        font: {
          size: 10,
          family: 'Open Sans, sans-serif'
        }
      },
      hoverlabel: {
        font: {
          family: 'Open Sans, sans-serif'
        }
      }
    };
    
    Plotly.newPlot(divId, traces, layout, {
      responsive: true,
      displayModeBar: false
    });
  }

  function syncAllCharts(xMin, xMax) {
    const topCountries = allCountries.slice(0, 15);
    const allChartIds = ['chart-all', ...topCountries.map(c => `chart-${c.replace(/\s+/g, '-')}`)];
    
    allChartIds.forEach(chartId => {
      const chartDiv = document.getElementById(chartId);
      if (chartDiv && chartDiv.layout) {
        Plotly.relayout(chartId, {
          'xaxis.range': [xMin, xMax]
        });
      }
    });
  }

  function createSharedSlider() {
    const sliderDiv = document.getElementById('timeSlider');
    
    // Get min and max time points
    const minTime = timePoints[0];
    const maxTime = timePoints[timePoints.length - 1];
    
    // Create a dummy trace just for the slider
    const trace = {
      x: timePoints,
      y: new Array(timePoints.length).fill(0),
      type: 'scatter',
      mode: 'lines',
      line: { width: 0 },
      showlegend: false,
      hoverinfo: 'skip'
    };
    
    const layout = {
      height: 80,
      margin: { l: 40, r: 40, t: 0, b: 40 },
      xaxis: {
        range: [minTime, maxTime],
        rangeslider: { 
          visible: true, 
          thickness: 0.1,
          range: [minTime, maxTime]
        },
        showticklabels: true,
        showgrid: false,
        showline: true,
        linecolor: '#ccc',
        ticks: 'outside',
        tickcolor: '#ccc'
      },
      yaxis: {
        visible: false,
        fixedrange: true
      },
      hovermode: false
    };
    
    Plotly.newPlot(sliderDiv, [trace], layout, {
      responsive: true,
      displayModeBar: false
    }).then(function() {
      sliderDiv.on('plotly_relayout', function(eventData) {
        if (eventData['xaxis.range[0]'] && eventData['xaxis.range[1]']) {
          syncAllCharts(eventData['xaxis.range[0]'], eventData['xaxis.range[1]']);
        }
      });
    });
  }
</script>

</body>
</html>